---
import Layout from "../layouts/Layout.astro"; // üîπ Cambio de alias @layouts a ruta relativa
const { frontmatter } = Astro.props;
const isEs = Astro.url.pathname.startsWith('/es');
// Charger les chambres selon la langue courante (Astro.glob n√©cessite des litt√©raux)
const roomsEn = await Astro.glob('/src/pages/accomodations/*.md');
const roomsEs = await Astro.glob('/src/pages/es/accomodations/*.md');
const rooms = isEs ? roomsEs : roomsEn;
const suggestedRooms = rooms.filter((room) => room.frontmatter.title !== frontmatter.title);
---

<Layout title={`${frontmatter.title} - La Casa Que Canta`}>

<section class="">
    <div>
       {(() => { const heroWebp = frontmatter.imagefront.replace(/\.(jpg|jpeg|png)$/i, '.webp'); return (
         <picture>
           <source srcset={heroWebp} type="image/webp" />
           <img class="h-72 w-full object-cover" src={frontmatter.imagefront} alt="" />
         </picture>
       ); })()}
    </div>
    <div class="max-w-7xl mx-auto py-16 px-8 grid gap-8 md:grid-cols-2 items-center">
        <div class="grid content-start h-full">
            <div class="mb-6 md:mb-12">
                <h1 class="text-5xl lg:text-7xl font-bold">{frontmatter.title}</h1>
                <div class="flex flex-wrap gap-2 lg:gap-6 font-medium mb-6">
                    <span class="flex items-center text-black/90 gap-2">
                        <!-- Iconos intactos -->
                        {frontmatter.square}
                    </span>
                    <span class="flex items-center text-black/90 gap-2">
                        {frontmatter.beds}
                    </span>
                    <span class="flex items-center text-black/90 gap-2">
                        {frontmatter.guest}
                    </span>
                </div>
                <div class="flex gap-4 flex-wrap">
                    <a href={frontmatter.book} target="_blank" class="w-full md:w-auto text-center text-sm bg-black/90 font-semibold uppercase py-3 px-6 text-white hover:bg-black/60">
                        {isEs ? 'RESERVAR' : 'Book Now'}
                    </a>
                    {frontmatter.floorplan && (
                        <>
                            <button id="open-dialog" class="w-full md:w-auto text-center text-sm bg-black/90 font-semibold uppercase py-3 px-6 text-white hover:bg-black/60 rounded-none">
                                {isEs ? 'Plano' : 'Floor Plan'}
                            </button>
                            <dialog id="floor-plan-dialog" class="p-0 overflow-hidden shadow-lg">
                                <div class="relative">
                                    <button id="close-dialog" class="absolute top-2 right-2 text-black/90 hover:text-black/90 focus:outline-none">
                                        <!-- Icono cerrar -->
                                    </button>
                                    <img src={frontmatter.floorplan} alt="Floor Plan" class="w-full h-auto object-contain aspect-square cursor-zoom-out" />
                                </div>
                            </dialog>
                        </>
                    )}
                    <a href="/accomodations" class="w-full md:w-auto text-center text-sm bg-black/90 font-semibold uppercase py-3 px-6 text-white hover:bg-black/60">
                        {isEs ? 'REGRESO A SUITES' : 'Back to accomodations'}
                    </a>
                </div>
                <mark class="font-bold">{frontmatter.description}</mark>
            </div>
            <slot />
        </div>
        <div class="grid gap-6">
            <div>
                <h4 class="font-bold">{isEs ? 'Caracteristicas de la Suite' : 'Room Features'}</h4>
                <ul>
                    {frontmatter.roomfeatures.map((feature) => (
                        <li>{feature.rf}</li>
                    ))}
                </ul>
            </div>
            <div>
                <h4 class="font-bold">{isEs ? 'Amenidades' : 'Amenities'}</h4>
                <ul>
                    {frontmatter.amenities.map((amenitie) => (
                        <li>{amenitie.a}</li>
                    ))}
                </ul>
            </div>
        </div>
    </div>

    <!-- Galer√≠a -->
    <div class="max-w-7xl px-8 md:px-0 mx-auto swiper mySwiper h-full pswp-gallery">
        <div class="swiper-wrapper aspect-square md:aspect-[16/7] object-cover">
            {frontmatter.items.map((item) => {
                const webp = item.image.replace(/\.(jpg|jpeg|png)$/i, '.webp');
                return (
                <div class="swiper-slide">
                    <a href={item.image} data-pswp-width="1600" data-pswp-height="1067" onclick="return window.__openSuiteLB ? window.__openSuiteLB(event,this) : false;">
                      <picture>
                          <source srcset={webp} type="image/webp" />
                          <img 
                              class="cursor-pointer object-cover transition duration-300 ease-in-out w-full h-full"
                              src={item.image}
                              alt={frontmatter.title}
                              data-image={item.image}
                              data-text={item.text}
                          />
                      </picture>
                    </a>
                </div>
            );
            })}
        </div>
        <div class="swiper-pagination"></div>
    </div>

    <div class="py-6 relative">
        <img src="/palm-bg-layout.png" class="hidden md:block absolute left-0 right-0 -top-16 mx-auto rotate-9" alt="">
    </div>

    <!-- Other rooms / Otras habitaciones -->
    <div class="grid relative max-w-7xl mx-auto">
        <div class="max-w-4xl px-4 mx-auto mb-10 text-center">
            <h2 class="text-3xl md:text-5xl lg:text-7xl mb-6 font-bold">{isEs ? 'Descubre m√°s suites' : 'Discover more suites'}</h2>
            <p>{isEs
                ? 'La Casa Que Canta es un peque√±o hotel de lujo con esencia, historia y una personalidad propia. Ubicado en Zihuatanejo junto a la hermosa playa La Ropa, este hotel ofrece vistas panor√°micas incomparables.'
                : 'La Casa Que Canta is a boutique hotel with essence, history and a personality of its own. Located in Zihuatanejo by the beautiful La Ropa beach, it offers incomparable panoramic views.'}
            </p>
        </div>
        <div class="grid gap-6 grid-cols-1 px-4 md:grid-cols-3 lg:grid-cols-4">
            {suggestedRooms.slice(0, 5).map((post) => {
                // Construire l'URL selon la langue courante
                const url = isEs
                    ? (post.url.startsWith('/es') ? post.url : `/es${post.url}`)
                    : (post.url.startsWith('/es') ? post.url.replace(/^\/es/, '') : post.url);
                return (
                    <div class="group relative bg-cover bg-center p-4 aspect-square grid items-end text-white overflow-hidden">
                        <div class="absolute z-10 w-full h-full top-0 bg-gradient-to-br from-transparent to-gray-900 opacity-60"></div>
                        <img class="absolute z-0 w-full h-full top-0 object-cover group-hover:scale-[1.02] transition duration-300 ease-in-out" src={post.frontmatter.imagefront} alt="" />
                        <h3 class="text-5xl z-20 relative">{post.frontmatter.title}</h3>
                        <div>
                            <a href={url} class="relative text-sm z-10 bg-black/90 font-semibold uppercase py-3 px-6 text-white hover:bg-black/60">{isEs ? 'M√°s detalles' : 'More details'}</a>
                        </div>
                    </div>
                );
            })}
        </div>
    </div>
</section>

<script is:inline>
const dialog = document.getElementById('floor-plan-dialog');
const openBtn = document.getElementById('open-dialog');
const closeBtn = document.getElementById('close-dialog');
if (openBtn && dialog) openBtn.addEventListener('click', () => dialog.showModal());
if (closeBtn && dialog) closeBtn.addEventListener('click', () => dialog.close());
if (dialog) dialog.addEventListener('click', () => dialog.close());
</script>

<script>
import Swiper from "swiper";
import { Pagination, Autoplay } from "swiper/modules";
import "swiper/css";
import "swiper/css/navigation";
import "swiper/css/pagination";

var swiper = new Swiper(".mySwiper", {
  modules: [Pagination, Autoplay],
  spaceBetween: 30,
  centeredSlides: true,
  autoplay: { delay: 4000, disableOnInteraction: false },
  pagination: { el: ".swiper-pagination", clickable: true },
  preventClicks: false,
  preventClicksPropagation: false
});

// Lightbox (PhotoSwipe) via CDN to √©viter d√©pendance
(function(){
  // Load CSS with fallback CDN
  const css = document.createElement('link');
  css.rel = 'stylesheet';
  css.href = 'https://unpkg.com/photoswipe@5/dist/photoswipe.css';
  css.onerror = () => { css.href = 'https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.css'; };
  document.head.appendChild(css);

  let __lbInstance = null;
  function initLightbox(){
    if (window.PhotoSwipeLightbox && window.PhotoSwipe) {
      const lb = new window.PhotoSwipeLightbox({
        gallery: '.pswp-gallery',
        children: 'a',
        // Use UMD core already loaded on window to avoid ESM import issues
        pswpModule: window.PhotoSwipe
      });
      __lbInstance = lb;
      lb.on('open', () => {
        const pswp = lb.pswp;
        // Create thumbnails sidebar
        const sidebar = document.createElement('div');
        sidebar.className = 'pswp-thumbs';
        const total = pswp.getNumItems();
        for (let i = 0; i < total; i++) {
          const data = pswp.getItemData(i);
          const img = document.createElement('img');
          img.src = data.msrc || data.src;
          img.loading = 'lazy';
          img.decoding = 'async';
          img.addEventListener('click', () => pswp.goTo(i));
          sidebar.appendChild(img);
        }
        pswp.element.appendChild(sidebar);
        // Explicit close button (top-right)
        const closeBtn = document.createElement('button');
        closeBtn.className = 'pswp-close-btn';
        closeBtn.type = 'button';
        closeBtn.setAttribute('aria-label','Close');
        closeBtn.addEventListener('click', () => pswp.close());
        pswp.element.appendChild(closeBtn);
        const updateActive = () => {
          const idx = pswp.currIndex;
          Array.from(sidebar.querySelectorAll('img')).forEach((el, i) => {
            el.classList.toggle('active', i === idx);
          });
        };
        pswp.on('change', updateActive);
        updateActive();
        pswp.on('destroy', () => { sidebar.remove(); closeBtn.remove(); });
      });
      lb.init();
      // Expose manual opener to prevent default navigation and open matching index
      window.__openSuiteLB = function(ev, anchor){
        if (ev) ev.preventDefault();
        const gallery = document.querySelector('.pswp-gallery');
        if (!gallery) return false;
        const links = Array.from(gallery.querySelectorAll('a'));
        const idx = Math.max(0, links.indexOf(anchor));
        try { lb.loadAndOpen(idx, gallery); } catch(e) {}
        return false;
      };
    }
  }
  // Load PhotoSwipe core then Lightbox (UMD)
  let coreLoaded = false, lbLoaded = false;
  function tryInit(){ if (coreLoaded && lbLoaded) initLightbox(); }
  const sCore = document.createElement('script');
  sCore.src = 'https://unpkg.com/photoswipe@5/dist/photoswipe.umd.min.js';
  sCore.defer = true;
  sCore.onload = () => { coreLoaded = true; tryInit(); };
  sCore.onerror = () => { sCore.src = 'https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe.umd.min.js'; };
  document.body.appendChild(sCore);
  const sLb = document.createElement('script');
  sLb.src = 'https://unpkg.com/photoswipe@5/dist/photoswipe-lightbox.umd.min.js';
  sLb.defer = true;
  sLb.onload = () => { lbLoaded = true; tryInit(); };
  sLb.onerror = () => { sLb.src = 'https://cdn.jsdelivr.net/npm/photoswipe@5/dist/photoswipe-lightbox.umd.min.js'; };
  document.body.appendChild(sLb);

  // Delegated click handler to ensure click opens even if scripts load tardively
  document.addEventListener('click', function(ev){
    const a = ev.target && ev.target.closest && ev.target.closest('.pswp-gallery a');
    if (!a) return;
    ev.preventDefault();
    const gallery = a.closest('.pswp-gallery');
    const links = Array.from(gallery.querySelectorAll('a'));
    const idx = Math.max(0, links.indexOf(a));
    let tries = 0;
    const open = () => {
      if (__lbInstance) { try { __lbInstance.loadAndOpen(idx, gallery); } catch(e) {} }
      else if (tries++ < 6) setTimeout(open, 50);
      else {
        // Fallback custom lightbox
        ensureCustomLightbox(gallery).open(idx);
      }
    };
    open();
  }, { capture: true });

  // Fallback: click anywhere on gallery (outside pagination) opens current slide
  document.addEventListener('click', function(ev){
    const gallery = ev.target && ev.target.closest && ev.target.closest('.pswp-gallery');
    if (!gallery) return;
    if (ev.target.closest('.swiper-pagination')) return; // ignore pagination dots
    ev.preventDefault();
    const idx = (typeof swiper?.activeIndex === 'number') ? swiper.activeIndex : 0;
    let tries = 0;
    const open = () => {
      if (__lbInstance) { try { __lbInstance.loadAndOpen(idx, gallery); } catch(e) {} }
      else if (tries++ < 6) setTimeout(open, 50);
      else {
        ensureCustomLightbox(gallery).open(idx);
      }
    };
    open();
  }, { capture: true });
  // Inject minimal CSS for desktop thumbnails
  const st = document.createElement('style');
  st.textContent = `
    .pswp-thumbs{position:fixed;right:20px;top:20px;bottom:20px;width:130px;overflow:auto;display:none;z-index:100050;background:rgba(0,0,0,.5);padding:8px 6px;border-radius:8px}
    @media(min-width:1024px){.pswp-thumbs{display:block}}
    .pswp-thumbs img{display:block;width:100%;height:auto;margin:0 0 8px 0;cursor:pointer;opacity:.9;border:2px solid transparent;box-sizing:border-box;transition:opacity .2s}
    .pswp-thumbs img:hover{opacity:1}
    .pswp-thumbs img.active{opacity:1;border-color:#eaeaea}
    .pswp-close-btn{position:fixed;right:170px;top:20px;z-index:100060;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:20px;width:32px;height:32px;display:none;align-items:center;justify-content:center;cursor:pointer}
    .pswp-close-btn:after{content:'√ó';font-size:18px;line-height:1}
    @media(min-width:1024px){.pswp-close-btn{display:flex}}
  `;
  document.head.appendChild(st);

  // ----------- Custom Lightbox fallback (discret + miniatures) -----------
  function ensureCustomLightbox(gallery){
    if (window.__slb) return window.__slb;
    const css = document.createElement('style');
    css.textContent = `
      .slb{position:fixed;inset:0;background:rgba(0,0,0,.95);display:none;z-index:99999}
      .slb.open{display:block}
      .slb-img{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);max-width:calc(100% - 180px);max-height:92%;box-shadow:0 10px 30px rgba(0,0,0,.6)}
      .slb-thumbs{position:absolute;right:20px;top:20px;bottom:20px;width:120px;overflow:auto;display:none}
      @media(min-width:1024px){.slb-thumbs{display:block}}
      .slb-thumbs img{display:block;width:100%;margin:0 0 8px 0;opacity:.9;border:2px solid transparent;cursor:pointer}
      .slb-thumbs img.active{opacity:1;border-color:#eaeaea}
      .slb-close{position:absolute;right:160px;top:20px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:18px;width:32px;height:32px;display:none;align-items:center;justify-content:center;cursor:pointer}
      .slb-close:after{content:'√ó';font-size:18px}
      @media(min-width:1024px){.slb-close{display:flex}}
      .slb-nav{position:absolute;top:50%;transform:translateY(-50%);left:10px;right:10px;display:flex;justify-content:space-between}
      .slb-btn{background:rgba(0,0,0,.45);color:#fff;border:0;width:36px;height:36px;border-radius:18px;cursor:pointer}
    `;
    document.head.appendChild(css);
    const lb = document.createElement('div'); lb.className='slb';
    const img = document.createElement('img'); img.className='slb-img'; lb.appendChild(img);
    const thumbs = document.createElement('div'); thumbs.className='slb-thumbs'; lb.appendChild(thumbs);
    const close = document.createElement('button'); close.className='slb-close'; close.type='button'; close.addEventListener('click', ()=>closeLb()); lb.appendChild(close);
    const nav = document.createElement('div'); nav.className='slb-nav';
    const prev = document.createElement('button'); prev.className='slb-btn'; prev.textContent='<';
    const next = document.createElement('button'); next.className='slb-btn'; next.textContent='>';
    nav.appendChild(prev); nav.appendChild(next); lb.appendChild(nav);
    document.body.appendChild(lb);
    const links = Array.from(gallery.querySelectorAll('a'));
    const urls = links.map(a=>a.getAttribute('href'));
    let index=0;
    urls.forEach((u,i)=>{ const t=document.createElement('img'); t.src=u; t.loading='lazy'; t.addEventListener('click',()=>show(i)); thumbs.appendChild(t); });
    function show(i){ index=(i+urls.length)%urls.length; img.src=urls[index]; Array.from(thumbs.children).forEach((el,j)=>el.classList.toggle('active',j===index)); }
    function open(i){ show(i); lb.classList.add('open'); }
    function closeLb(){ lb.classList.remove('open'); }
    lb.addEventListener('click',e=>{ if(e.target===lb) closeLb(); });
    document.addEventListener('keydown',e=>{ if(!lb.classList.contains('open')) return; if(e.key==='Escape') closeLb(); if(e.key==='ArrowRight') show(index+1); if(e.key==='ArrowLeft') show(index-1); });
    prev.addEventListener('click',()=>show(index-1)); next.addEventListener('click',()=>show(index+1));
    window.__slb = { open };
    return window.__slb;
  }
})();
</script>
</Layout>
